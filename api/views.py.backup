from rest_framework import viewsets, status, generics
from rest_framework.decorators import action
from rest_framework.response import Response
from rest_framework.permissions import IsAuthenticated, IsAdminUser, AllowAny
from django.contrib.auth.models import User
from django.db.models import Count, Q
from django.utils import timezone
from .models import Building, Department, Faculty, Office, Assignment
from .serializers import (
    BuildingSerializer, DepartmentSerializer, FacultySerializer, 
    OfficeSerializer, AssignmentSerializer
)

# SignUp View
class SignUpView(generics.CreateAPIView):
    """User registration endpoint"""
    queryset = User.objects.all()
    permission_classes = [AllowAny]
    
    def create(self, request, *args, **kwargs):
        username = request.data.get('username')
        password = request.data.get('password')
        email = request.data.get('email', '')
        
        if not username or not password:
            return Response(
                {'error': 'Username and password required'}, 
                status=status.HTTP_400_BAD_REQUEST
            )
        
        if User.objects.filter(username=username).exists():
            return Response(
                {'error': 'Username already exists'}, 
                status=status.HTTP_400_BAD_REQUEST
            )
        
        user = User.objects.create_user(
            username=username, 
            password=password,
            email=email
        )
        
        return Response(
            {
                'message': 'User created successfully',
                'username': user.username
            }, 
            status=status.HTTP_201_CREATED
        )

# Public ViewSets (for regular users)
class BuildingViewSet(viewsets.ReadOnlyModelViewSet):
    queryset = Building.objects.all()
    serializer_class = BuildingSerializer
    permission_classes = [IsAuthenticated]

class DepartmentViewSet(viewsets.ReadOnlyModelViewSet):
    queryset = Department.objects.all()
    serializer_class = DepartmentSerializer
    permission_classes = [IsAuthenticated]

class FacultyViewSet(viewsets.ReadOnlyModelViewSet):
    queryset = Faculty.objects.select_related('department').all()
    serializer_class = FacultySerializer
    permission_classes = [IsAuthenticated]

class OfficeViewSet(viewsets.ReadOnlyModelViewSet):
    queryset = Office.objects.select_related('building', 'department').all()
    serializer_class = OfficeSerializer
    permission_classes = [IsAuthenticated]

class AssignmentViewSet(viewsets.ReadOnlyModelViewSet):
    queryset = Assignment.objects.select_related('faculty', 'office', 'office__building').all()
    serializer_class = AssignmentSerializer
    permission_classes = [IsAuthenticated]

# Admin ViewSets (CRUD operations)
class AdminBuildingViewSet(viewsets.ModelViewSet):
    queryset = Building.objects.all()
    serializer_class = BuildingSerializer
    permission_classes = [IsAdminUser]

class AdminDepartmentViewSet(viewsets.ModelViewSet):
    queryset = Department.objects.all()
    serializer_class = DepartmentSerializer
    permission_classes = [IsAdminUser]

class AdminFacultyViewSet(viewsets.ModelViewSet):
    queryset = Faculty.objects.select_related('department').all()
    serializer_class = FacultySerializer
    permission_classes = [IsAdminUser]
    
    @action(detail=False, methods=['get'])
    def stats(self, request):
        """Get faculty statistics"""
        total = Faculty.objects.count()
        by_department = Faculty.objects.values('department__name').annotate(count=Count('staff_id'))
        
        return Response({
            'total': total,
            'by_department': list(by_department)
        })

class AdminOfficeViewSet(viewsets.ModelViewSet):
    queryset = Office.objects.select_related('building', 'department').all()
    serializer_class = OfficeSerializer
    permission_classes = [IsAdminUser]
    
    @action(detail=False, methods=['get'])
    def stats(self, request):
        """Get office statistics"""
        total = Office.objects.count()
        by_floor = Office.objects.values('floor_id').annotate(count=Count('room_id'))
        occupied = Assignment.objects.filter(
            Q(end_date__isnull=True) | Q(end_date__gte=timezone.now().date())
        ).values('office').distinct().count()
        
        return Response({
            'total': total,
            'occupied': occupied,
            'available': total - occupied,
            'by_floor': list(by_floor)
        })

class AdminAssignmentViewSet(viewsets.ModelViewSet):
    queryset = Assignment.objects.select_related('faculty', 'office', 'office__building').all()
    serializer_class = AssignmentSerializer
    permission_classes = [IsAdminUser]
    
    @action(detail=False, methods=['get'])
    def stats(self, request):
        """Get assignment statistics"""
        total = Assignment.objects.count()
        active = Assignment.objects.filter(
            Q(end_date__isnull=True) | Q(end_date__gte=timezone.now().date())
        ).count()
        
        return Response({
            'total': total,
            'active': active,
            'expired': total - active
        })
    
    @action(detail=False, methods=['post'])
    def bulk_assign(self, request):
        """Bulk assign faculty to offices"""
        assignments = request.data.get('assignments', [])
        created = []
        
        for assignment_data in assignments:
            serializer = self.get_serializer(data=assignment_data)
            if serializer.is_valid():
                serializer.save()
                created.append(serializer.data)
        
        return Response({
            'created': len(created),
            'assignments': created
        }, status=status.HTTP_201_CREATED)